using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using Photon.Pun;
public class HealItem : /*MonoBehaviour*/ MonoBehaviourPunCallbacks
{
    //プレイヤー
    private GameObject player;
    private float heal;
    //音
    private AudioSource audioSource;

    [SerializeField]
    private AudioClip sound;

    // Start is called before the first frame update
    void Start()
    {
        //回復量
        heal = 20.0f;
        //プレイヤー探索
        SearchPlayer();
        //音
        audioSource = GetComponent<AudioSource>();

    }

    // Update is called once per frame
    void Update()
    {
        float sin = Mathf.Sin(Time.time);
        this.transform.position = new Vector3(
            transform.position.x,
            (sin * 0.03f) + transform.position.y,
            transform.position.z
            );
    }
    void OnTriggerEnter(Collider t)
    {
        if (photonView.IsMine)
        {
            //プレイヤーと接触したら
            if (t.gameObject.layer == 8)
            {
                //プレイヤー ismine
                if (t.gameObject.GetComponent<PhotonView>().IsMine)
                    //接触したら回復
                    HealPlayer();

                //取得再生
                audioSource.PlayOneShot(sound);

                //非アクティブにする
                photonView.RPC(nameof(ActiveObj), RpcTarget.All);

                //3秒後にアイテムアクティブ
                Invoke("ActiveHealItem", 3);

                //削除
                //PhotonNetwork.Destroy(this.gameObject);
            }
        }
    }

    // 回復する
    private void HealPlayer()
    {
        //プレイヤーに回復
        player.transform.GetChild(0).GetComponent<TankHealth>().HealHP(heal);
    }
    public void SearchPlayer()
    {
        // ルーム内のネットワークオブジェクト
        foreach (var photonView in PhotonNetwork.PhotonViewCollection)
        {
            //boat かつ　自分
            if (photonView.gameObject.name == "Boat(Clone)")
            {
                if (photonView.IsMine)
                {
                    Debug.Log("[" + GetInstanceID() + "]" + "Player Find");
                    player = PhotonView.Find(photonView.ViewID).gameObject;
                }
            }
        }
    }

    private void ActiveHealItem()
    {
        // scene object
        Scene scene = GameObject.Find("Scene").GetComponent<Scene>();
        //スポーン用文字配列
        string[] s = scene.GetItemString();
        for (int i = 0; i < s.Length; i++)
        {
            if (s[i] == "FirstAidKit")
            {
                ////アイテムがスポーンしていない座標の乱数に座標を貰う
                Vector3 vec = scene.MoveItem(i);
                //バリアをアクティブにする
                photonView.RPC(nameof(Move), RpcTarget.All, vec);
            }

        }
    }

    [PunRPC]

    private void Move(Vector3 vec)
    {
        //移動
        this.gameObject.transform.position = vec;
        //アイテム表示
        gameObject.SetActive(true);

    }
    [PunRPC]
    private void ActiveObj()
    {
        //アイテム非表示
        gameObject.SetActive(false);
    }
}
